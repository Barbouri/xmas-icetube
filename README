##################
## xmas-icetube ##
##################

My father gave me an Ice Tube Clock kit from Adafruit as a Christmas gift last
year.  As an excuse to learn AVR programming, I started playing with the
software.  Eventually, none of the original code remained and the project
became a feature-rich reimplementation of the original Adafruit firmware.

  John Archie <www.jarchie.com>
  December 27, 2012


##############
## FEATURES ##
##############

Many of the features in the xmas-icetube firmware were first implemented in
other firmware projects; see the CREDITS file for details.  This firmware
boasts the following features.

  - animated display transitions
  - multiple time and date formats
  - optionally pulse display during alarm and snooze
  - three alarm times for selectable days of the week
  - adjustable alarm volume (from 0 to 10)
  - progressive alarm option (gradually increasing volume)
  - multiple alarm sounds (beeps, Merry Christmas, Big Ben, or Reveille)
  - adjustable snooze duration
  - DST support (USA, EU, or manual)
  - fully automatic correction for time drift
  - time-from-GPS support*
  - no beeping or time loss when power fails
  - 25-fold increase in backup battery life*
  - functional alarm during power outage**
  - per-digit brightness adjustment for uneven displays
  - automatic brightness control by ambient light*
  - optionally disable display during specified time periods
  - optionally disable display at night (when dark)*

*  These hacks require hardware modification and support must be enabled by
   uncommenting macros in config.h.  See the HACKS AND MODS section of
   this file as well as the comments in config.h for more information.

** The snooze feature, musical alarm, and progressive alarm, are automatically
   disabled during a power failure.  While on battery power, the buzzer alarm
   sounds at the menu-settable maximum volume and the alarm can only be enabled
   or disabled via the alarm on/off switch.  All other inputs are ignored until
   power is restored.


For Ice Tube Clock hackers, this firmware has

    (1) compatibility with the ATMEGA328P-PU,
    (2) a pseudo object-oriented design,
    (3) reasonably good commenting, and
    (4) display/menus by finite state machine.


##################
## INSTALLATION ##
##################

Installation requires GNU Make, avr-libc, avr-gcc, and avrdude; the
instructions below presume proficiency with these tools.

*** IMPORTANT ***
This firmware requires the ATMEGA328P-PU:  not the ATMEGA168V included
with the Ice Tube Clock kit.  Due to all the features, this firmware
currently requires ~25 kb of flash, but the ATMEGA168V only has 16 kb.
Also, if your ATMEGA328P-PU has an Arduino bootloader installed, it
will not work without reconfiguration.  See the section entitled
USING AN ARDUINO CHIP.

Programming has been tested with the Adafruit USBtinyISP and the Atmel
AVR Dragon, but other avrdude-supported ISP programmers should work.

In regard to software, compilation and installation seems to work under

    (a) Ubuntu Linux 12.04 with the avr-gcc and avrdude packages,
    (b) Mac OS 10.6 with MacPorts' avr-gcc and avrdude packages, and
    (c) Windows 7 with WinAVR and Cygwin's perl and bash packages.

To compile and install this firmware, first configure compile-time
options by editing config.h; then, build and install the project using
the included Makefile:

(1) Edit the Configuration Variables

    First, review the macro definitions in config.h, changing macro
    definitions as needed to enable support for various hardware hacks.

    Next, review the Makefile to ensure that configuration variables
    are reasonable given your hardware.  In particular, AVRISP and
    AVRDUDEOPT seem most likely to require attention.

(2) Compile the Firmware

    Build icetube_flash.hex and icetube_eeprom.hex, which contain
    the firmware and initial EEPROM contents:

	% make

(3) Connect the Programmer

    Before unplugging the clock, reduce the display brightness to the
    minimum.  Ensure the clock has an ATMEGA328P-PU installed and not
    an ATMEGA168V.  Unplug and disassemble the clock.  Most users
    report that the clock cannot be programmed without removing the
    side PCB with VFD tube, so remove that.  Reconnect the power
    adaptor.  Connect the AVR programmer to the clock's ISP header,
    ensuring that pin one on the cable (red wire) and the marked pin
    on the clock's ISP header match.

(4) Install the Firmware

    Write the new fuse bits, which *do* differ from those in the original
    Adafruit firmware and other alternative firmware projects:

	% make install-fuse

    Finally, upload the compiled firmware and initial EEPROM contents:

	% make install


###########################
## USING AN ARDUINO CHIP ##
###########################

The Arduino Uno chip is an ATMEGA328P-PU, but will not work in an Ice
Tube Clock without reconfiguration.  Arduino chips have their fuse
settings configured to use an external 16 MHz oscillator for the
system clock.  The Ice Tube Clock does not provide a suitable external
oscillator, and without an external oscillator, an Arduino chip will
not function--not even to be reconfigured.

To provide an external oscillator for reconfiguration, insert the
Arduino chip into an Arduino board.  Next, connect a programmer to the
ISP on the Arduino board and reprogram the fuses with the xmas-icetube
Makefile:  "make install-fuse".  The ATMEGA328P-PU's fuse settings are
now configured to use the 8 MHz internal oscillator.  The chip may be
installed in an Ice Tube Clock clock and programmed as described in
the INSTALLATION section.


####################
## HACKS AND MODS ##
####################

Development of the various hacks and mods supported by this firmware
have been discussed extensively in the Adafruit discussion board.

::Automatic Dimmer::
http://forums.adafruit.com/viewtopic.php?f=41&t=12932

::Temperature Compensated Timekeeping::
http://forums.adafruit.com/viewtopic.php?f=41&t=14941

::GPS Timekeeping::
http://forums.adafruit.com/viewtopic.php?f=41&t=36873
http://www.ladyada.net/make/icetube/mods.html
http://forums.adafruit.com/viewtopic.php?f=41&t=32660

::Extended Battery Hack::
http://forums.adafruit.com/viewtopic.php?f=41&t=36697

::Sleep During Power Failure::
http://forums.adafruit.com/viewtopic.php?f=41&t=22515

::Drift Correction::
http://forums.adafruit.com/viewtopic.php?f=41&t=12720

::Per-Digit Brightness Adjustment::
http://forums.adafruit.com/viewtopic.php?f=41&t=23586
