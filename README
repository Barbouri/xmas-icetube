##################
## xmas-icetube ##
##################

My father gave me an Ice Tube Clock kit from Adafruit as a Christmas gift last
year.  As an excuse to learn AVR programming, I started playing with the
software.  Eventually, none of the origional code remained and the project
became a feature-rich reimplementation of the original Adafruit firmware.

  John Archie <www.jarchie.com>
  December 7, 2012


##############
## Features ##
##############

This firmware boasts many features including,

    (1) three alarms by time and days of the week,
    (2) adjustable alarm volume (11 levels),
    (3) progressive alarm option (low to high volume),
    (4) three alarm sounds (beeps, Merry Christmas, or Big Ben),
    (5) adjustable snooze time,
    (6) DST support (USA, EU, or manual),
    (7) automatic drift correction,
    (8) time-from-GPS support,
    (9) alarm sounds during power outage,*
   (10) no beeping or time loss after power failure,
   (11) per-digit brightness control,
   (12) optionally set brightness by ambient light,** and
   (13) optionally disable display at night (when dark)**
   (14) animated display transitions (inspired by Jeremy Fitzhardinge's
	firmware:  https://github.com/jsgf/iceclock)

*  The snooze feature, musical alarm, and progressive alarm, are automatically
   disabled during a power failure.  While on battery power, the buzzer alarm
   sounds at a menu-settable maximum volume and the alarm can only be enabled
   or disabled via the alarm on/off switch.  All other inputs are ignored until
   power is restored.

** Both features require a CdS photoresistor with 10-20k pull-up resistor.


For Ice Tube Clock hackers, this firmware has

    (1) compatibility with the atmega328p,
    (2) a pseudo object-oriented design,
    (3) reasonably good commenting, and
    (4) display/menus by finite state machine.


##################
## Installation ##
##################

Installation requires GNU Make, avr-libc, avr-gcc, and avrdude;
the instructions below presume proficiency with these tools.

In regard to hardware, this Makefile is setup to build and install the firmware
for the Adafruit Ice Tube Clock with an ATmega328P.  Unfortunately, this
firmware is currently too large to work on the ATmega168V.  Programming has
been tested with the Adafruit USBtinyISP, but other controllers should also
work (in theory).

In regard to software, compilation and installation seems to work under

    (a) Ubuntu Linux 12.04 with the avr-gcc and avrdude packages,
    (b) Mac OS 10.6 with MacPorts' avr-gcc and avrdude packages, and
    (c) Windows 7 with WinAVR and Cygwin's perl and bash packages.

To compile and install this firmware, edit and use the provided Makefile:

(1) Edit Configuration Variables

    Review the Makefile to ensure that configuration variables are
    reasonable given your hardware.  In particular, AVRMCU, AVRISP,
    and AVRDUDEOPT seem most likely to require attention.

(2) Compile the Firmware

    Build icetube_flash.hex and icetube_eeprom.hex, which contain
    the firmware and initial EEPROM contents:

	% make

(3) Install the Firmware

    Write the new fuse bits, which *do* differ from those in the original
    Adafruit firmware:

	% make install-fuse

    Finally, upload the compiled firmware and initial EEPROM contents:

	% make install


###############
## Wish List ##
###############

I am likely to implement the following features eventually...

(1) Firmware should detect absence of a photoresistor and
    disable relevant menu options.

(2) Implement graphical display transitions like the jgsf-icetube firmware.

(3) I am thinking about adding a countdown timer and/or stopwatch.

(4) I am also thinking about different time and date formats, but am not sure
    if I will actually do it.  The current display suits me quite well.
    Currently, the user may only select between 12 and 24 hour time display.

    "set tfmt"
        - toggle 24-hour mode	"hours 24"  "hours 12"
        - toggle am/pm:		"a/pm cir"  "a/pm dot"  "a/pm txt"  "a/pm off"
        - toggle seconds	"sec show"  "sec hide"
        - toggle showdst        "dst  cir"  "dst  dot"  "dst hide"

    "set dfmt"
        - toggle weekday        "wday  on"  "wday off"
        - date format		"date dmy"  "date mdy"  "date txt"  "date iso"
