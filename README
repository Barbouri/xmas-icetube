##################
## xmas-icetube ##
##################

My father gave me an Ice Tube Clock kit from Adafruit as a Christmas gift last
year.  As an excuse to learn AVR programming, I started playing with the
software.  Eventually, none of the origional code remained and the project
became a feature-rich reimplementation of the original Adafruit firmware.

  John Archie <www.jarchie.com>
  December 7, 2012


##############
## Features ##
##############

This firmware boasts many features including,

    (1) adjustable alarm volume (11 levels),
    (3) progressive alarm option (low to high volume),
    (2) musical alarm option ("Merry Christmas" or buzzer),
    (4) DST support (USA, EU, or manual),
    (5) automatic drift correction,
    (6) time-from-GPS support,
    (7) alarm sounds during power outage,*
    (8) no reset or time loss during power failure,
    (9) per-digit brightness control,
   (10) optionally set brightness by ambient light,** and
   (11) optionally disable display at night (when dark)**

*  The snooze feature, musical alarm, and progressive alarm, are automatically
   disabled during a power failure.  While on battery power, the buzzer alarm
   sounds at a menu-settable maximum volume and the alarm can only be enabled
   or disabled via the alarm on/off switch.  All other inputs are ignored until
   power is restored.

** Both features require a CdS photoresistor with 10-20k pull-up resistor.


For Ice Tube Clock hackers, this firmware has

    (1) compatibility with the atmega328p,
    (2) a pseudo object-oriented design,
    (3) reasonably good commenting, and
    (4) display/menus by finite state machine.


##################
## Installation ##
##################

Installation requires GNU Make, avr-libc, avr-gcc, and avrdude;
the instructions below presume proficiency with these tools.

In regard to hardware, the Makefile is setup to build and install the
firmware for the Adafruit Ice Tube Clock with an ATmega328P, not the
ATmega168V which is included in the kit.  To program the clock,
everything works with the Adafruit USBtinyISP.  In theory, this
firmware should work with the ATmega168V or other avrdude-compatible
programmers by changing Makefile configuration variables.

In regard to software, compilation and installation seems to work under

    (a) Ubuntu Linux 12.04 with the avr-gcc and avrdude packages,
    (b) Mac OS 10.6 with MacPorts' avr-gcc and avrdude packages, and
    (c) Windows 7 with WinAVR and Cygwin's perl and bash packages.

To compile and install this firmware, edit and use the provided Makefile:

(1) Edit Configuration Variables

    Review the Makefile to ensure that configuration variables are
    reasonable given your hardware.  In particular, AVRMCU, AVRISP,
    and AVRDUDEOPT seem most likely to require attention.

(2) Compile the Firmware

    Build icetube_flash.hex and icetube_eeprom.hex, which contain
    the firmware and initial EEPROM contents:

	% make

(3) Install the Firmware

    Write the new fuse bits, which *do* differ from those in the original
    Adafruit firmware:

	% make install-fuse

    Finally, upload the compiled firmware and initial EEPROM contents:

	% make install


###############
## Wish List ##
###############

I am likely to implement the following features eventually...

(1) Autodim support should be explicitly enabled/disabled by a macro.

(2) Time-from-GPS support should be explicitly enabled/disabled by macro.

(3) I am thinking about adding a countdown timer and/or stopwatch.

(4) I am also thinking about different time and date formats, but am not sure
    if I will actually do it.  The current display suits me quite well.
    Currently, the user may only select between 12 and 24 hour time display.

    "set tfmt"
        - toggle 24-hour mode	"hours 24"  "hours 12"
        - toggle am/pm:		"a/pm cir"  "a/pm dot"  "a/pm txt"  "a/pm off"
        - toggle seconds	"sec show"  "sec hide"
        - toggle showdst        "dst  cir"  "dst  dot"  "dst hide"

    "set dfmt"
        - toggle weekday        "wday  on"  "wday off"
        - date format		"date dmy"  "date mdy"  "date txt"  "date iso"
